name: Discord Notify

on:
  issues:
    types: [opened, closed, reopened]
  pull_request:
    types: [opened, closed, reopened]

jobs:
  notify:
    runs-on: ubuntu-latest
    steps:
      - name: Send message to Discord
        env:
          WEBHOOK: ${{ secrets.DISCORD_WEBHOOK_URL }}
          EVENT_NAME: ${{ github.event_name }}
          ACTOR: ${{ github.actor }}
          REPO: ${{ github.repository }}
          ISSUE_TITLE: ${{ github.event.issue.title }}
          ISSUE_URL: ${{ github.event.issue.html_url }}
          ISSUE_NUMBER: ${{ github.event.issue.number }}
          ISSUE_ACTION: ${{ github.event.action }}
          PR_TITLE: ${{ github.event.pull_request.title }}
          PR_URL: ${{ github.event.pull_request.html_url }}
          PR_NUMBER: ${{ github.event.pull_request.number }}
          PR_ACTION: ${{ github.event.action }}
          PR_BASE: ${{ github.event.pull_request.base.ref }}
          PR_HEAD: ${{ github.event.pull_request.head.ref }}
        run: |
          set -e

          if [ "$EVENT_NAME" = "issues" ]; then
            content=$(cat <<EOF
          ðŸ§¾ **Issue ${ISSUE_ACTION}**
          ðŸ“Œ **${REPO}** #${ISSUE_NUMBER}
          ðŸ“ ${ISSUE_TITLE}
          ðŸ‘¤ ${ACTOR}
          ðŸ”— ${ISSUE_URL}
          EOF
            )
          else
            content=$(cat <<EOF
          ðŸ” **PR ${PR_ACTION}**
          ðŸ“Œ **${REPO}** #${PR_NUMBER}
          ðŸ“ ${PR_TITLE}
          ðŸŒ¿ ${PR_HEAD} â†’ ${PR_BASE}
          ðŸ‘¤ ${ACTOR}
          ðŸ”— ${PR_URL}
          EOF
            )
          fi

          payload=$(jq -n --arg content "$content" '{content: $content}')
          curl -s -H "Content-Type: application/json" -d "$payload" "$WEBHOOK"
